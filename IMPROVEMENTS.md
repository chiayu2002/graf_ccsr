# GRAF-CCSR 質量改進

## 改進概述

本次更新顯著提升了生成圖像的清晰度和質量，通過以下幾個關鍵改進：

## 主要改進

### 1. 增強的超分辨率網絡架構

**之前：**
- 簡單的3層卷積網絡
- 64個特徵通道
- 有限的特徵提取能力

**現在：**
- 深度殘差網絡架構
- 8個殘差塊（可配置）
- 更強的特徵提取和細節保留能力
- 漸進式2x上採樣（對於4x超分辨率）

**影響：** 顯著提升細節重建能力，減少模糊現象

### 2. 改進的一致性執行模組（CEM）

**之前：**
- 固定的殘差權重（0.5）
- 無法自適應調整

**現在：**
- 可學習的殘差權重參數
- 使用sigmoid激活確保權重在合理範圍
- 模型可以自動學習最優的一致性強制力度

**影響：** 更好的低分辨率一致性和高分辨率細節平衡

### 3. VGG感知損失

**新增功能：**
- 基於VGG19的感知損失
- 在特徵空間而非像素空間計算損失
- 更好地保留高頻細節和紋理

**影響：** 生成的圖像視覺質量更高，細節更清晰

### 4. 改進的激活函數

**之前：**
- LeakyReLU + clamp(-1, 1)
- 可能限制輸出表現力

**現在：**
- 使用tanh激活函數
- 更平滑的梯度流
- 更好的訓練穩定性

## 配置參數

新增配置參數（在 `configs/default.yaml` 中）：

```yaml
ccsr:
    enabled: True
    num_views: 8
    scale_factor: 4
    num_res_blocks: 8          # 殘差塊數量
    alpha_init: 1.0
    alpha_decay: 0.0001
    perceptual_weight: 0.1     # 感知損失權重
```

### 參數調整建議

1. **num_res_blocks**:
   - 更多殘差塊 = 更好的質量，但計算量更大
   - 建議範圍：6-12
   - 默認：8

2. **perceptual_weight**:
   - 控制感知損失的影響力
   - 過高可能導致過度強調紋理
   - 建議範圍：0.05-0.2
   - 默認：0.1

3. **alpha_init / alpha_decay**:
   - 控制CCSR損失隨訓練的衰減
   - 允許模型先學習基本結構，後期關注細節

## 文件修改

1. **graf/models/ccsr.py**
   - 添加 `ResidualBlock` 類
   - 重構 `CCSR` 網絡架構
   - 改進 `ConsistencyEnforcingModule`

2. **graf/train_step.py**
   - 添加 `VGGPerceptualLoss` 類
   - 增強 `CCSRNeRFLoss` 以包含感知損失

3. **graf/models/generator.py**
   - 支持傳遞CCSR配置參數

4. **graf/config.py**
   - 從配置文件讀取CCSR參數

5. **train.py**
   - 使用新的損失函數配置

6. **configs/default.yaml**
   - 添加新的CCSR配置參數

## 預期效果

1. **更清晰的圖像**：殘差網絡提供更強的特徵提取
2. **更好的細節**：感知損失保留高頻細節和紋理
3. **更少的模糊**：改進的網絡架構和損失函數
4. **更穩定的訓練**：可學習的權重和改進的激活函數

## 使用建議

1. 如果顯存充足，可以增加 `num_res_blocks` 到 10 或 12
2. 如果圖像過於銳化，降低 `perceptual_weight`
3. 如果圖像仍然模糊，增加 `perceptual_weight` 到 0.15-0.2
4. 訓練時監控 `loss/ccsr_consistency` 以確保收斂

## 性能影響

- 計算量增加：約 2-3倍（由於深度網絡和感知損失）
- 顯存需求：增加約 20-30%
- 訓練時間：每次迭代增加約 30-40%

建議在有足夠GPU資源的情況下使用這些改進。
